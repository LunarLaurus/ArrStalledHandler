name: Delete Docker image on release deletion

on:
  release:
    types: [deleted]

jobs:
  delete_from_registry:
    name: Delete Docker image from Docker Hub
    runs-on: ubuntu-latest
    steps:
      - name: Delete Docker image
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          IMAGE_NAME: ${{ vars.DOCKER_IMAGE }}
          TAG: ${{ github.event.release.tag_name }}
        run: |
          # Extract namespace and repository from IMAGE_NAME
          NAMESPACE=$(echo $IMAGE_NAME | cut -d'/' -f1)
          REPOSITORY=$(echo $IMAGE_NAME | cut -d'/' -f2)
          
          echo "Authenticating with Docker Hub..."
          TOKEN=$(curl -s -H "Content-Type: application/json" \
            -X POST \
            -d '{"username": "'"$DOCKER_USERNAME"'", "password": "'"$DOCKER_PASSWORD"'"}' \
            https://hub.docker.com/v2/users/login/ | jq -r .token)
          
          echo "Deleting image tag '$TAG' from repository '$NAMESPACE/$REPOSITORY'..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: JWT $TOKEN" \
            -X DELETE \
            https://hub.docker.com/v2/repositories/$NAMESPACE/$REPOSITORY/tags/$TAG/)
          
          if [ "$RESPONSE" -eq 204 ]; then
            echo "Image tag '$TAG' deleted successfully."
          else
            echo "Failed to delete image tag '$TAG'. HTTP response code: $RESPONSE"
            exit 1
          fi
